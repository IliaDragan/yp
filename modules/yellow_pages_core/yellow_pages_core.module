<?php
/**
 * @file
 * Core functionality, not suitable to be specifically placed anywhere else.
 */

include_once 'yellow_pages_core.fields.inc';

/**
 * Implements hook_menu().
 */
function yellow_pages_core_menu() {
  $items = array();

  $items['admin/config/yp'] = array(
    'title' => 'Yellow Pages',
    'description' => 'Yellow Pages related settings',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  // @todo
  // CSRF token
  $items['node/%node/geomap'] = array(
    'title' => 'Geo map',
    'description' => 'Rendered map for certain node',
    'page callback' => 'yellow_pages_core_node_geomap',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Return field renderable array with a map for a certain node.
 *
 * @param stdClass $node
 *   The node object.
 *
 * @return array
 *   Render array with geo field data.
 */
function yellow_pages_core_node_geomap(stdClass $node) {
  $entity = $node;
  $entity_type = 'node';
  $geo_items = field_get_items($entity_type, $entity, 'field_geocode');

  if (!$geo_items) {
    return drupal_not_found();
  }

  $settings = array(
    'geofield_map_baselayers_hybrid' => 1,
    'geofield_map_baselayers_map' => 1,
    'geofield_map_baselayers_physical' => 0,
    'geofield_map_baselayers_satellite' => 1,
    'geofield_map_center' => array(
      'geocode' => 'Find my location',
      'lat' => '',
      'lon' => ''
    ),
    'geofield_map_controltype' => 'default',
    'geofield_map_draggable' => 1,
    'geofield_map_height' => '768px',
    'geofield_map_maptype' => 'map',
    'geofield_map_max_zoom' => 0,
    'geofield_map_min_zoom' => 0,
    'geofield_map_mtc' => 'none',
    'geofield_map_overview' => 0,
    'geofield_map_overview_opened' => 0,
    'geofield_map_pancontrol' => 1,
    'geofield_map_scale' => 1,
    'geofield_map_scrollwheel' => 1,
    'geofield_map_streetview_show' => 1,
    'geofield_map_width' => '100%',
    'geofield_map_zoom' => 18,
  );

  $field = array('field_name' => 'field_address');
  $instance = array();
  $langcode = LANGUAGE_NONE;

  $geo_map = geofield_map_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $geo_items, array('settings' => $settings));

  $geo_map['#prefix'] = "<h1>{$entity->title}</h1>";

  drupal_set_title($entity->title . variable_set('site_name', 'YELLOW PAGES OF MOLDOVA'));

  return $geo_map;
}

/**
 * Implements hook_FORM_ID_alter().
 *
 * Enrich site settings with additional description field.
 */
function yellow_pages_core_form_system_site_information_settings_alter(&$form, &$form_state) {
  $form['site_information']['site_description'] = array(
    '#type' => 'textfield',
    '#title' => t('Site description'),
    '#default_value' => variable_get('site_description'),
  );

  $form['site_information']['site_mail']['#weight'] = '99';
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Adds a password reset link.
 */
function yellow_pages_core_form_user_login_alter(&$form, &$form_state) {
  $form['pass_reset'] = array(
    '#type' => 'item',
    '#markup' => l(t('Request new password'), 'user/password', array('attributes' => array('title' => t('Request new password via e-mail.')))),
  );
}

/**
 * Implements hook_user_logout().
 */
function yellow_pages_core_user_logout($account) {
  // Unset cookies.
  if (isset($_SERVER['HTTP_COOKIE'])) {
    $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
    foreach($cookies as $cookie) {
      $parts = explode('=', $cookie);
      $name = trim($parts[0]);
      setrawcookie($name, '', REQUEST_TIME - 3600, '/');
    }
  }
}

/**
 * Callback function that finds node translations.
 * @param int $tnid
 *   Translation node id.
 *
 * @return array
 *   Array of translation node nids with language as array-keys.
 */
function yellow_pages_core_node_get_translation_nids($tnid) {
  $translations = array();
  $result = db_select('node', 'n')
    ->fields('n', array('nid', 'language'))
    ->condition('n.tnid', $tnid)
    ->execute();

  foreach ($result as $node) {
    $langcode = $node->language;
    $translations[$langcode] = $node->nid;
  }

  return $translations;
}

/**
 * Creating date collection between two dates
 *
 * @param string $first
 *   Timestamp since.
 * @param string $last
 *   Timestamp until.
 * @param string $step
 * @param string $output_format
 *   Format of output dates.
 *
 * @return array of dates.
 */
function yellow_pages_core_date_range($first, $last, $step = '+1 day', $output_format = 'd/m/Y', $key_format = 'Ymd') {
  $dates = array();
  $current = $first;

  while( $current <= $last ) {
    $key = date($key_format, $current);
    $dates[$key] = format_date($current, 'custom', $output_format);
    $current = strtotime($step, $current);
  }

  return $dates;
}

/**
 * Get weekdays' names for current language.
 *
 * @return array
 *   Array of all weekdays translated full names.
 */
function yellow_pages_core_get_weekdays() {
  return array(
    'Monday' => t('Monday'),
    'Tuesday' => t('Tuesday'),
    'Wednesday' => t('Wednesday'),
    'Thursday' => t('Thursday'),
    'Friday' => t('Friday'),
    'Saturday' => t('Saturday'),
    'Sunday' => t('Sunday')
  );
}

/**
 * Get day hours from 00:00 to 24:00 with half hour range.
 *
 * @return array
 *   Array of times strings.
 */
function yellow_pages_core_get_day_hours() {
  $day_hours = array();
  for ($i = 0; $i <= 96; $i++) {
    $j = $i * 15;
    $h = (int) ($j / 60);
    $m = $j % 60;
    $hour = str_pad($h, 2, '0', STR_PAD_LEFT) . ":" . str_pad($m, 2, '0', STR_PAD_RIGHT);
    $day_hours[$hour] = $hour;
  }

  return $day_hours;
}

/**
 * Implements hook_block_info()
 */
function yellow_pages_core_block_info() {

  $blocks['criteo_300_250'] = array(
    'info' => t('Criteo 300x250'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  $blocks['adsense_300_250'] = array(
    'info' => t('AdSense 300x250'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  $blocks['adsense_front_468_60_left'] = array(
    'info' => t('AdSense Front'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  $blocks['adsense_news_728_90_first'] = array(
    'info' => t('AdSense News'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );


  $blocks['adsense_front_468_60_right'] = array(
    'info' => t('Criteo 468x60'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

/*  $blocks['adsense_news_728_90_first'] = array(
    'info' => t('AdSense News 728x90 First'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );*/

  $blocks['adsense_news_728_90_second'] = array(
    'info' => t('Criteo 728x90'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function yellow_pages_core_block_view($delta = '') {
  // This example is adapted from node.module.
  $block = array();


  $block['subject'] = '';
  switch ($delta) {
    case 'adsense_front_468_60_left':
    case 'adsense_news_728_90_first':
    case 'adsense_news_728_90_second':
      $block['content'] = yellow_pages_core_get_adsense_adaptive();
      break;
    case 'adsense_300_250':
      $block['content'] = yellow_pages_core_get_adsense_300_250();
      break;
    case 'adsense_front_468_60_right':
      $block['content'] = yellow_pages_core_get_criteo_468_60();
      break;
//    case 'criteo_728_90':
 //     $block['content'] = yellow_pages_core_get_criteo_728_90();
 //     break;
    case 'criteo_300_250':
      $block['content'] = yellow_pages_core_get_criteo_300_250();
      break;

 /*   case 'adsense_company_300_250':
    case 'adsense_search_300_250':
      $block['subject'] = '';
      $block['content'] = yellow_pages_core_get_300_250_ad_block_content();
      break;

    case 'adsense_front_468_60_left':
      $block['subject'] = '';
      $block['content'] = yellow_pages_core_get_google_adsense();
      break;

    case 'adsense_front_468_60_right':
      $block['subject'] = '';
      $block['content'] = yellow_pages_core_get_468_60_ad_block_content();
      break;

    case 'adsense_news_728_90_first':
      $block['subject'] = '';
      $block['content'] = yellow_pages_core_get_google_adsense();
      break;

    case 'adsense_news_728_90_second':
      $block['subject'] = '';
      $block['content'] = yellow_pages_core_get_728_90_ad_block_content();
      break;*/


  }
  return $block;
}

/**
 * Get Criteo ad for 300x250px block.
 */
function yellow_pages_core_get_criteo_300_250() {
  return "<script type='text/javascript'>
<!--//<![CDATA[
document.MAX_ct0 ='';
var m3_u = (location.protocol=='https:'?'https://cas.criteo.com/delivery/ajs.php?':'http://cas.criteo.com/delivery/ajs.php?');
var m3_r = Math.floor(Math.random()*99999999999);
document.write (\"<scr\"+\"ipt type='text/javascript' src='\"+m3_u);
document.write (\"zoneid=384256\");document.write(\"&amp;nodis=1\");
document.write ('&amp;cb=' + m3_r);
if (document.MAX_used != ',') document.write (\"&amp;exclude=\" + document.MAX_used);
document.write (document.charset ? '&amp;charset='+document.charset : (document.characterSet ?
'&amp;charset='+document.characterSet : ''));
document.write (\"&amp;loc=\" + escape(window.location).substring(0,1600));
if (document.context) document.write (\"&context=\" + escape(document.context));
if ((typeof(document.MAX_ct0) != 'undefined') && (document.MAX_ct0.substring(0,4) == 'http')) {
document.write (\"&amp;ct0=\" + escape(document.MAX_ct0));
}
if (document.mmm_fo) document.write (\"&amp;mmm_fo=1\");
document.write (\"'></scr\"+\"ipt>\");
//]]>--></script>";
}

/**
 * Get Criteo ad for 468x60px block.
 */
function yellow_pages_core_get_criteo_468_60() {
  return "<script type='text/javascript'>
<!--//<![CDATA[
document.MAX_ct0 ='';
var m3_u = (location.protocol=='https:'?'https://cas.criteo.com/delivery/ajs.php?':'http://cas.criteo.com/delivery/ajs.php?');
var m3_r = Math.floor(Math.random()*99999999999);
document.write (\"<scr\"+\"ipt type='text/javascript' src='\"+m3_u);
document.write (\"zoneid=388187\");document.write(\"&amp;nodis=1\");
document.write ('&amp;cb=' + m3_r);
if (document.MAX_used != ',') document.write (\"&amp;exclude=\" + document.MAX_used);
document.write (document.charset ? '&amp;charset='+document.charset : (document.characterSet ?
'&amp;charset='+document.characterSet : ''));
document.write (\"&amp;loc=\" + escape(window.location).substring(0,1600));
if (document.context) document.write (\"&context=\" + escape(document.context));
if ((typeof(document.MAX_ct0) != 'undefined') && (document.MAX_ct0.substring(0,4) == 'http')) {
document.write (\"&amp;ct0=\" + escape(document.MAX_ct0));
}
if (document.mmm_fo) document.write (\"&amp;mmm_fo=1\");
document.write (\"'></scr\"+\"ipt>\");
//]]>--></script>";
}

/**
 * Get Criteo ad for 728x90px block.
 */
function yellow_pages_core_get_criteo_728_90() {
  return "<script type='text/javascript'>
<!--//<![CDATA[
document.MAX_ct0 ='';
var m3_u = (location.protocol=='https:'?'https://cas.criteo.com/delivery/ajs.php?':'http://cas.criteo.com/delivery/ajs.php?');
var m3_r = Math.floor(Math.random()*99999999999);
document.write (\"<scr\"+\"ipt type='text/javascript' src='\"+m3_u);
document.write (\"zoneid=388188\");document.write(\"&amp;nodis=1\");
document.write ('&amp;cb=' + m3_r);
if (document.MAX_used != ',') document.write (\"&amp;exclude=\" + document.MAX_used);
document.write (document.charset ? '&amp;charset='+document.charset : (document.characterSet ?
'&amp;charset='+document.characterSet : ''));
document.write (\"&amp;loc=\" + escape(window.location).substring(0,1600));
if (document.context) document.write (\"&context=\" + escape(document.context));
if ((typeof(document.MAX_ct0) != 'undefined') && (document.MAX_ct0.substring(0,4) == 'http')) {
document.write (\"&amp;ct0=\" + escape(document.MAX_ct0));
}
if (document.mmm_fo) document.write (\"&amp;mmm_fo=1\");
document.write (\"'></scr\"+\"ipt>\");
//]]>--></script>";
}


/**
 * Get google AdSense block for 300x250
 */
function yellow_pages_core_get_adsense_300_250() {
  return "<script async src=\"//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js\"></script>
<!-- yp.md&yellowpages.md_300x250px -->
<ins class=\"adsbygoogle\"
 style=\"display:inline-block;width: 100%; height: 250px\"
 data-ad-client=\"ca-pub-4252189351312901\"
 data-ad-slot=\"1584816871\"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>";
}


/**
 * Get google AdSense adaptive block content.
 */
function yellow_pages_core_get_adsense_adaptive() {
  if (in_array($_SERVER['SERVER_NAME'], array('yp.md', 'www.yp.md'))) {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- yp.md_auto -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4252189351312901"
       data-ad-slot="9560898878"
       data-ad-format="auto"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>';
  }
  else {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- yellowpages.md_auto -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4252189351312901"
       data-ad-slot="2037632074"
       data-ad-format="auto"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>';
  }
}
