<?php
/**
 * @file
 * Core functionality, not suitable to be specifically placed anywhere else.
 */

/**
 * Implements hook_menu().
 */
function yellow_pages_core_menu() {
  $items = array();

  $items['admin/config/yp'] = array(
    'title' => 'Yellow Pages',
    'description' => 'Yellow Pages related settings',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  return $items;
}

/**
 * Implements hook_FORM_ID_alter().
 *
 * Enrich site settings with additional description field.
 */
function yellow_pages_core_form_system_site_information_settings_alter(&$form, &$form_state) {
  $form['site_information']['site_description'] = array(
    '#type' => 'textfield',
    '#title' => t('Site description'),
    '#default_value' => variable_get('site_description'),
  );

  $form['site_information']['site_mail']['#weight'] = '99';
}

/**
 * Implements hook_user_logout().
 */
function yellow_pages_core_user_logout($account) {
  // Unset cookies.
  if (isset($_SERVER['HTTP_COOKIE'])) {
    $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
    foreach($cookies as $cookie) {
      $parts = explode('=', $cookie);
      $name = trim($parts[0]);
      setrawcookie($name, '', REQUEST_TIME - 3600, '/');
    }
  }
}

/**
 * Callback function that finds node translations.
 * @param int $tnid
 *   Translation node id.
 *
 * @return array
 *   Array of translation node nids with language as array-keys.
 */
function yellow_pages_core_node_get_translation_nids($tnid) {
  $translations = array();
  $result = db_select('node', 'n')
    ->fields('n', array('nid', 'language'))
    ->condition('n.tnid', $tnid)
    ->execute();

  foreach ($result as $node) {
    $langcode = $node->language;
    $translations[$langcode] = $node->nid;
  }

  return $translations;
}

/**
 * Creating date collection between two dates
 *
 * @param string $first
 *   Timestamp since.
 * @param string $last
 *   Timestamp until.
 * @param string $step
 * @param string $output_format
 *   Format of output dates.
 *
 * @return array of dates.
 */
function yellow_pages_core_date_range($first, $last, $step = '+1 day', $output_format = 'd/m/Y', $key_format = 'Ymd') {
  $dates = array();
  $current = $first;

  while( $current <= $last ) {
    $key = date($key_format, $current);
    $dates[$key] = format_date($current, 'custom', $output_format);
    $current = strtotime($step, $current);
  }

  return $dates;
}

/**
 * Implements hook_block_info()
 */
function yellow_pages_core_block_info() {
  $blocks['adsense_300_250'] = array(
    'info' => t('AdSense 300x250'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  $blocks['adsense_front_468_60_left'] = array(
    'info' => t('AdSense 468x60 left'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  $blocks['adsense_news_728_90'] = array(
    'info' => t('AdSense News'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );


  $blocks['adsense_front_468_60_right'] = array(
    'info' => t('AdSense 468x60 right'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function yellow_pages_core_block_view($delta = '') {
  // This example is adapted from node.module.
  $block = array();


  $block['subject'] = '';
  switch ($delta) {
    case 'adsense_300_250':
      $block['content'] = yellow_pages_core_get_adsense_300_250();
      break;
    case 'adsense_front_468_60_right':
    case 'adsense_front_468_60_left':
      $block['content'] = yellow_pages_core_get_adsense_468_60();
      break;
    case 'adsense_news_728_90':
      $block['content'] = yellow_pages_core_get_adsense_728_90();
      break;
  }
  return $block;
}

/**
 * Get AdSense ad for 728x90px block.
 */
function yellow_pages_core_get_adsense_728_90() {
  if (in_array($_SERVER['SERVER_NAME'], array('yp.md', 'www.yp.md'))) {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yp.md_728x90px -->
<ins class="adsbygoogle"
 style="display:inline-block;width:728px;height:90px"
 data-ad-client="ca-pub-4252189351312901"
 data-ad-slot="4729439674"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>'; 
  } else {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 728x90px_yellowpages.md -->
<ins class="adsbygoogle"
 style="display:inline-block;width:728px;height:90px"
 data-ad-client="ca-pub-4252189351312901"
 data-ad-slot="3113105679"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>';
  }
}


/**
 * Get google AdSense block for 300x250.
 */
function yellow_pages_core_get_adsense_300_250() {
   if (in_array($_SERVER['SERVER_NAME'], array('yp.md', 'www.yp.md'))) {
  return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 300x250px_yp.md -->
<ins class="adsbygoogle"
 style="display:inline-block;width:300px;height:250px"
 data-ad-client="ca-pub-4252189351312901"
 data-ad-slot="7543305270"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>';
  } else {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- yellowpages.md_300x250px -->
<ins class="adsbygoogle"
style="display:inline-block;width:300px;height:250px"
data-ad-client="ca-pub-4252189351312901"
data-ad-slot="1584816871"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>'; 
  }
}


/**
 * Get google AdSense 468x60.
 */
function yellow_pages_core_get_adsense_468_60() {
  if (in_array($_SERVER['SERVER_NAME'], array('yp.md', 'www.yp.md'))) {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 468x60px_yp.md -->
<ins class="adsbygoogle"
 style="display:inline-block;width:468px;height:60px"
 data-ad-client="ca-pub-4252189351312901"
 data-ad-slot="7682906072"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>';
  }
  else {
    return '<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 468x60px_yellowpages.md -->
<ins class="adsbygoogle"
 style="display:inline-block;width:468px;height:60px"
 data-ad-client="ca-pub-4252189351312901"
 data-ad-slot="6066572072"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>';
  }
}
