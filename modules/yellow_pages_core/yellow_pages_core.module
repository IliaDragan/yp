<?php
/**
 * @file
 * Core functionality, not suitable to be specifically placed anywhere else.
 */

include_once 'yellow_pages_core.fields.inc';

/**
 * Implements hook_menu().
 */
function yellow_pages_core_menu() {
  $items = array();

  $items['admin/config/yp'] = array(
    'title' => 'Yellow Pages',
    'description' => 'Yellow Pages related settings',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  // @todo
  // CSRF token
  $items['node/%node/geomap'] = array(
    'title' => 'Geo map',
    'description' => 'Rendered map for certain node',
    'page callback' => 'yellow_pages_core_node_geomap',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Return field renderable array with a map for a certain node.
 *
 * @param stdClass $node
 *   The node object.
 *
 * @return array
 *   Render array with geo field data.
 */
function yellow_pages_core_node_geomap(stdClass $node) {
  $entity = $node;
  $entity_type = 'node';
  $geo_items = field_get_items($entity_type, $entity, 'field_geocode');

  if (!$geo_items) {
    return drupal_not_found();
  }

  $settings = array(
    'geofield_map_baselayers_hybrid' => 1,
    'geofield_map_baselayers_map' => 1,
    'geofield_map_baselayers_physical' => 0,
    'geofield_map_baselayers_satellite' => 1,
    'geofield_map_center' => array(
      'geocode' => 'Find my location',
      'lat' => '',
      'lon' => ''
    ),
    'geofield_map_controltype' => 'default',
    'geofield_map_draggable' => 1,
    'geofield_map_height' => '768px',
    'geofield_map_maptype' => 'map',
    'geofield_map_max_zoom' => 0,
    'geofield_map_min_zoom' => 0,
    'geofield_map_mtc' => 'none',
    'geofield_map_overview' => 0,
    'geofield_map_overview_opened' => 0,
    'geofield_map_pancontrol' => 1,
    'geofield_map_scale' => 1,
    'geofield_map_scrollwheel' => 1,
    'geofield_map_streetview_show' => 1,
    'geofield_map_width' => '100%',
    'geofield_map_zoom' => 18,
  );

  $field = array('field_name' => 'field_address');
  $instance = array();
  $langcode = LANGUAGE_NONE;

  $geo_map = geofield_map_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $geo_items, array('settings' => $settings));

  $geo_map['#prefix'] = "<h1>{$entity->title}</h1>";

  drupal_set_title($entity->title . variable_set('site_name', 'YELLOW PAGES OF MOLDOVA'));

  return $geo_map;
}

/**
 * Implements hook_FORM_ID_alter().
 *
 * Enrich site settings with additional description field.
 */
function yellow_pages_core_form_system_site_information_settings_alter(&$form, &$form_state) {
  $form['site_information']['site_description'] = array(
    '#type' => 'textfield',
    '#title' => t('Site description'),
    '#default_value' => variable_get('site_description'),
  );

  $form['site_information']['site_mail']['#weight'] = '99';
}

/**
 * Implements hook_user_logout().
 */
function yellow_pages_core_user_logout($account) {
  // Unset cookies.
  if (isset($_SERVER['HTTP_COOKIE'])) {
    $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
    foreach($cookies as $cookie) {
      $parts = explode('=', $cookie);
      $name = trim($parts[0]);
      setrawcookie($name, '', REQUEST_TIME - 3600, '/');
    }
  }
}

/**
 * Callback function that finds node translations.
 * @param int $tnid
 *   Translation node id.
 *
 * @return array
 *   Array of translation node nids with language as array-keys.
 */
function yellow_pages_core_node_get_translation_nids($tnid) {
  $translations = array();
  $result = db_select('node', 'n')
    ->fields('n', array('nid', 'language'))
    ->condition('n.tnid', $tnid)
    ->execute();

  foreach ($result as $node) {
    $langcode = $node->language;
    $translations[$langcode] = $node->nid;
  }

  return $translations;
}

/**
 * Creating date collection between two dates
 *
 * @param string $first
 *   Timestamp since.
 * @param string $last
 *   Timestamp until.
 * @param string $step
 * @param string $output_format
 *   Format of output dates.
 *
 * @return array of dates.
 */
function yellow_pages_core_date_range($first, $last, $step = '+1 day', $output_format = 'd/m/Y', $key_format = 'Ymd') {
  $dates = array();
  $current = $first;

  while( $current <= $last ) {
    $key = date($key_format, $current);
    $dates[$key] = format_date($current, 'custom', $output_format);
    $current = strtotime($step, $current);
  }

  return $dates;
}
